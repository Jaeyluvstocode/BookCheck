<!DOCTYPE html>
<html>
<head>
    <title>Review Test</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        button { padding: 10px 20px; font-size: 14px; cursor: pointer; margin: 5px; }
        div { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        #output { background: #f9f9f9; min-height: 200px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Review System Test</h1>
    <button onclick="testReview()">Test Review Submission</button>
    <button onclick="clearOutput()">Clear Output</button>
    <div id="output"></div>

    <script>
        const API = 'http://localhost:3001/api';
        let testToken = null;
        let testBookId = null;
        let testUserId = null;

        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            console.log(msg);
        }

        function clearOutput() {
            document.getElementById('output').textContent = '';
        }

        async function testReview() {
            clearOutput();
            try {
                log('1. Registering user...');
                const regRes = await fetch(`${API}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: `user_${Date.now()}`,
                        email: `test_${Date.now()}@example.com`,
                        password: 'test123'
                    })
                });
                const regData = await regRes.json();
                log(`Status: ${regRes.status}, Message: ${regData.message}`);
                if (!regRes.ok) {
                    log('❌ Registration failed');
                    return;
                }
                testToken = regData.token;
                testUserId = regData.user.id;
                log(`✅ Registered, Token: ${testToken.substring(0, 20)}...`);

                log('\n2. Creating book...');
                const bookRes = await fetch(`${API}/books`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${testToken}`
                    },
                    body: JSON.stringify({
                        title: `Test Book ${Date.now()}`,
                        authors: ['Test Author'],
                        genre: 'Test Genre',
                        description: 'A test book'
                    })
                });
                const bookData = await bookRes.json();
                log(`Status: ${bookRes.status}, Title: ${bookData.title}`);
                if (!bookRes.ok) {
                    log('❌ Book creation failed:', bookData);
                    return;
                }
                testBookId = bookData._id;
                log(`✅ Book created, ID: ${testBookId}`);

                log('\n3. Submitting review...');
                const reviewRes = await fetch(`${API}/books/${testBookId}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${testToken}`
                    },
                    body: JSON.stringify({
                        rating: 5,
                        comment: 'Great book!'
                    })
                });
                const reviewData = await reviewRes.json();
                log(`Status: ${reviewRes.status}`);
                log(`Response: ${JSON.stringify(reviewData, null, 2)}`);
                if (reviewRes.ok) {
                    log(`✅ Review submitted successfully!`);
                    log(`Review rating: ${reviewData.review?.rating}`);
                    log(`Avg rating: ${reviewData.avgRating}`);
                } else {
                    log(`❌ Review submission failed: ${reviewData.message}`);
                }

                log('\n4. Fetching book to verify review...');
                const getRes = await fetch(`${API}/books/${testBookId}`, {
                    headers: { 'Authorization': `Bearer ${testToken}` }
                });
                const bookDetail = await getRes.json();
                log(`Book has ${bookDetail.reviews.length} reviews`);
                log(`Book avg rating: ${bookDetail.avgRating}`);
                log(`✅ Test complete!`);
            } catch (err) {
                log(`❌ Error: ${err.message}`);
                log(`Stack: ${err.stack}`);
            }
        }
    </script>
</body>
</html>
